# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to you under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# Tests planner rules related to semi-join optimizations (SEMI_JOIN_REMOVE rule).
#
# Ensure that tests occur in alphabetical order:
# // lint: sort where '^[#] test'
#

!use scott
!set outputformat mysql

# testRemoveSemiJoin -----------------------------------------------------------
# SEMI_JOIN_REMOVE removes a redundant semi-join when the join is already
# enforced by an inner join.
# Not using !ok: result row order is non-deterministic for a join.

select e.ename from emp e, dept d
where e.deptno = d.deptno;
LogicalProject(ENAME=[$1])
  LogicalJoin(condition=[=($7, $9)], joinType=[inner], semiJoinDone=[true])
    LogicalJoin(condition=[=($7, $9)], joinType=[semi])
      LogicalTableScan(table=[[CATALOG, SALES, EMP]])
      LogicalTableScan(table=[[CATALOG, SALES, DEPT]])
    LogicalTableScan(table=[[CATALOG, SALES, DEPT]])
!sub-plan "NONE, FILTER_INTO_JOIN, JOIN_ADD_REDUNDANT_SEMI_JOIN"
LogicalProject(ENAME=[$1])
  LogicalJoin(condition=[=($7, $9)], joinType=[inner], semiJoinDone=[true])
    LogicalTableScan(table=[[CATALOG, SALES, EMP]])
    LogicalTableScan(table=[[CATALOG, SALES, DEPT]])
!sub-plan "NONE, FILTER_INTO_JOIN, JOIN_ADD_REDUNDANT_SEMI_JOIN, SEMI_JOIN_REMOVE"

# testRemoveSemiJoinRight ------------------------------------------------------
# SEMI_JOIN_REMOVE removes a redundant semi-join on the right side of a join
# when the join is already enforced by a transitive inner join.
# Not using !ok: result row order is non-deterministic for a join.

select e1.ename from emp e1, dept d, emp e2
where e1.deptno = d.deptno and d.deptno = e2.deptno;
LogicalProject(ENAME=[$1])
  LogicalJoin(condition=[=($9, $18)], joinType=[inner], semiJoinDone=[true])
    LogicalJoin(condition=[=($7, $9)], joinType=[inner], semiJoinDone=[true])
      LogicalJoin(condition=[=($7, $9)], joinType=[semi])
        LogicalTableScan(table=[[CATALOG, SALES, EMP]])
        LogicalTableScan(table=[[CATALOG, SALES, DEPT]])
      LogicalJoin(condition=[=($0, $9)], joinType=[semi])
        LogicalTableScan(table=[[CATALOG, SALES, DEPT]])
        LogicalTableScan(table=[[CATALOG, SALES, EMP]])
    LogicalTableScan(table=[[CATALOG, SALES, EMP]])
!sub-plan "NONE, FILTER_INTO_JOIN, JOIN_ADD_REDUNDANT_SEMI_JOIN, SEMI_JOIN_JOIN_TRANSPOSE"
LogicalProject(ENAME=[$1])
  LogicalJoin(condition=[=($9, $18)], joinType=[inner], semiJoinDone=[true])
    LogicalJoin(condition=[=($7, $9)], joinType=[inner], semiJoinDone=[true])
      LogicalTableScan(table=[[CATALOG, SALES, EMP]])
      LogicalTableScan(table=[[CATALOG, SALES, DEPT]])
    LogicalTableScan(table=[[CATALOG, SALES, EMP]])
!sub-plan "NONE, FILTER_INTO_JOIN, JOIN_ADD_REDUNDANT_SEMI_JOIN, SEMI_JOIN_JOIN_TRANSPOSE, SEMI_JOIN_REMOVE"

# testRemoveSemiJoinRightWithFilter --------------------------------------------
# SEMI_JOIN_REMOVE removes a redundant semi-join on the right side of a join
# when the join is already enforced by a transitive inner join, with a filter.
# Not using !ok: result row order is non-deterministic for a join.

select e1.ename from emp e1, dept d, emp e2
where e1.deptno = d.deptno and d.deptno = e2.deptno
and d.dname = 'foo';
LogicalProject(ENAME=[$1])
  LogicalJoin(condition=[=($9, $18)], joinType=[inner], semiJoinDone=[true])
    LogicalJoin(condition=[=($7, $9)], joinType=[inner], semiJoinDone=[true])
      LogicalJoin(condition=[=($7, $9)], joinType=[semi])
        LogicalTableScan(table=[[CATALOG, SALES, EMP]])
        LogicalFilter(condition=[=($1, 'foo')])
          LogicalTableScan(table=[[CATALOG, SALES, DEPT]])
      LogicalFilter(condition=[=($1, 'foo')])
        LogicalJoin(condition=[=($0, $9)], joinType=[semi])
          LogicalTableScan(table=[[CATALOG, SALES, DEPT]])
          LogicalTableScan(table=[[CATALOG, SALES, EMP]])
    LogicalTableScan(table=[[CATALOG, SALES, EMP]])
!sub-plan "NONE, FILTER_INTO_JOIN, JOIN_ADD_REDUNDANT_SEMI_JOIN, SEMI_JOIN_JOIN_TRANSPOSE, SEMI_JOIN_FILTER_TRANSPOSE"
LogicalProject(ENAME=[$1])
  LogicalJoin(condition=[=($9, $18)], joinType=[inner], semiJoinDone=[true])
    LogicalJoin(condition=[=($7, $9)], joinType=[inner], semiJoinDone=[true])
      LogicalTableScan(table=[[CATALOG, SALES, EMP]])
      LogicalFilter(condition=[=($1, 'foo')])
        LogicalTableScan(table=[[CATALOG, SALES, DEPT]])
    LogicalTableScan(table=[[CATALOG, SALES, EMP]])
!sub-plan "NONE, FILTER_INTO_JOIN, JOIN_ADD_REDUNDANT_SEMI_JOIN, SEMI_JOIN_JOIN_TRANSPOSE, SEMI_JOIN_FILTER_TRANSPOSE, SEMI_JOIN_REMOVE"

# testRemoveSemiJoinWithFilter -------------------------------------------------
# SEMI_JOIN_REMOVE removes a redundant semi-join when the join is already
# enforced by an inner join, with a filter on the left side.
# Not using !ok: result row order is non-deterministic for a join.

select e.ename from emp e, dept d
where e.deptno = d.deptno and e.ename = 'foo';
LogicalProject(ENAME=[$1])
  LogicalJoin(condition=[=($7, $9)], joinType=[inner], semiJoinDone=[true])
    LogicalFilter(condition=[=($1, 'foo')])
      LogicalJoin(condition=[=($7, $9)], joinType=[semi])
        LogicalTableScan(table=[[CATALOG, SALES, EMP]])
        LogicalTableScan(table=[[CATALOG, SALES, DEPT]])
    LogicalTableScan(table=[[CATALOG, SALES, DEPT]])
!sub-plan "NONE, FILTER_INTO_JOIN, JOIN_ADD_REDUNDANT_SEMI_JOIN, SEMI_JOIN_FILTER_TRANSPOSE"
LogicalProject(ENAME=[$1])
  LogicalJoin(condition=[=($7, $9)], joinType=[inner], semiJoinDone=[true])
    LogicalFilter(condition=[=($1, 'foo')])
      LogicalTableScan(table=[[CATALOG, SALES, EMP]])
    LogicalTableScan(table=[[CATALOG, SALES, DEPT]])
!sub-plan "NONE, FILTER_INTO_JOIN, JOIN_ADD_REDUNDANT_SEMI_JOIN, SEMI_JOIN_FILTER_TRANSPOSE, SEMI_JOIN_REMOVE"

# End semi-join.iq
