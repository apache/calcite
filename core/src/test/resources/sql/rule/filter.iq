# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to you under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# Tests planner rules related to Filter.
#
# Ensure that tests occur in alphabetical order:
# // lint: sort where '^[#] test'
#

!use scott
!set outputformat mysql

# testFilterProjectTransposeRule2 ---------------------------------------------
# FILTER_PROJECT_TRANSPOSE should not push the Filter past the Project
# when the Filter contains a Subquery with correlation.
# [CALCITE-6873]

select * from (select deptno from emp) as d
where NOT EXISTS (
  select count(*) from emp e where e.deptno = d.deptno);
+--------+
| DEPTNO |
+--------+
+--------+
(0 rows)

!ok
LogicalProject(DEPTNO=[$0])
  LogicalFilter(condition=[NOT(EXISTS({
LogicalAggregate(group=[{}], EXPR$0=[COUNT()])
  LogicalProject($f0=[0])
    LogicalFilter(condition=[=($7, $cor0.DEPTNO)])
      LogicalTableScan(table=[[CATALOG, SALES, EMP]])
}))], variablesSet=[[$cor0]])
    LogicalProject(DEPTNO=[$7])
      LogicalTableScan(table=[[CATALOG, SALES, EMP]])
!sub-plan "NONE"
LogicalProject(DEPTNO=[$0])
  LogicalFilter(condition=[NOT(EXISTS({
LogicalAggregate(group=[{}], EXPR$0=[COUNT()])
  LogicalProject($f0=[0])
    LogicalFilter(condition=[=($7, $cor0.DEPTNO)])
      LogicalTableScan(table=[[CATALOG, SALES, EMP]])
}))], variablesSet=[[$cor0]])
    LogicalProject(DEPTNO=[$7])
      LogicalTableScan(table=[[CATALOG, SALES, EMP]])
!sub-plan "NONE, FILTER_PROJECT_TRANSPOSE"

# testFilterProjectTransposeRule3 ---------------------------------------------
# FILTER_PROJECT_TRANSPOSE should push the Filter past the Project
# when the Filter does not contain a correlated Subquery.

select * from (select deptno from emp) as d
where NOT EXISTS (
  select count(*) from emp e);
+--------+
| DEPTNO |
+--------+
+--------+
(0 rows)

!ok
LogicalProject(DEPTNO=[$0])
  LogicalFilter(condition=[NOT(EXISTS({
LogicalAggregate(group=[{}], EXPR$0=[COUNT()])
  LogicalProject($f0=[0])
    LogicalTableScan(table=[[CATALOG, SALES, EMP]])
}))])
    LogicalProject(DEPTNO=[$7])
      LogicalTableScan(table=[[CATALOG, SALES, EMP]])
!sub-plan "NONE"
LogicalProject(DEPTNO=[$0])
  LogicalProject(DEPTNO=[$7])
    LogicalFilter(condition=[NOT(EXISTS({
LogicalAggregate(group=[{}], EXPR$0=[COUNT()])
  LogicalProject($f0=[0])
    LogicalTableScan(table=[[CATALOG, SALES, EMP]])
}))])
      LogicalTableScan(table=[[CATALOG, SALES, EMP]])
!sub-plan "NONE, FILTER_PROJECT_TRANSPOSE"

# End filter.iq
