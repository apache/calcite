<?xml version="1.0" ?>
<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one or more
  ~ contributor license agreements.  See the NOTICE file distributed with
  ~ this work for additional information regarding copyright ownership.
  ~ The ASF licenses this file to you under the Apache License, Version 2.0
  ~ (the "License"); you may not use this file except in compliance with
  ~ the License.  You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<Root>
  <TestCase name="testNoSharedExpressionsDifferentFilters">
    <Resource name="planBefore">
      <![CDATA[
Combine
  LogicalProject(EMPNO=[$0])
    LogicalFilter(condition=[=($7, 10)])
      LogicalTableScan(table=[[scott, EMP]])
  LogicalProject(ENAME=[$1])
    LogicalFilter(condition=[=($2, 'CLERK')])
      LogicalTableScan(table=[[scott, EMP]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
EnumerableCombine
  EnumerableProject(EMPNO=[$0])
    EnumerableFilter(condition=[=($7, 10)])
      EnumerableTableScan(table=[[scott, EMP]])
  EnumerableProject(ENAME=[$1])
    EnumerableFilter(condition=[=($2, 'CLERK')])
      EnumerableTableScan(table=[[scott, EMP]])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testNoSharedExpressionsDifferentGroupByKeys">
    <Resource name="planBefore">
      <![CDATA[
Combine
  LogicalAggregate(group=[{7}], CNT=[COUNT()])
    LogicalTableScan(table=[[scott, EMP]])
  LogicalAggregate(group=[{2}], CNT=[COUNT()])
    LogicalTableScan(table=[[scott, EMP]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
EnumerableCombine
  EnumerableAggregate(group=[{7}], CNT=[COUNT()])
    EnumerableTableScan(table=[[scott, EMP]])
  EnumerableAggregate(group=[{2}], CNT=[COUNT()])
    EnumerableTableScan(table=[[scott, EMP]])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testNoSharedExpressionsDifferentJoinTypes">
    <Resource name="planBefore">
      <![CDATA[
Combine
  LogicalProject(EMPNO=[$0], DNAME=[$9])
    LogicalJoin(condition=[=($7, $8)], joinType=[inner])
      LogicalTableScan(table=[[scott, EMP]])
      LogicalTableScan(table=[[scott, DEPT]])
  LogicalProject(EMPNO=[$0], DNAME=[$9])
    LogicalJoin(condition=[=($7, $8)], joinType=[full])
      LogicalTableScan(table=[[scott, EMP]])
      LogicalTableScan(table=[[scott, DEPT]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
EnumerableCombine
  EnumerableProject(EMPNO=[$3], DNAME=[$1])
    EnumerableHashJoin(condition=[=($0, $10)], joinType=[inner])
      EnumerableTableScan(table=[[scott, DEPT]])
      EnumerableTableScan(table=[[scott, EMP]])
  EnumerableProject(EMPNO=[$0], DNAME=[$9])
    EnumerableHashJoin(condition=[=($7, $8)], joinType=[full])
      EnumerableTableScan(table=[[scott, EMP]])
      EnumerableTableScan(table=[[scott, DEPT]])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testNoSharedExpressionsDifferentJoins">
    <Resource name="planBefore">
      <![CDATA[
Combine
  LogicalProject(ENAME=[$1], DNAME=[$9])
    LogicalJoin(condition=[=($7, $8)], joinType=[inner])
      LogicalTableScan(table=[[scott, EMP]])
      LogicalTableScan(table=[[scott, DEPT]])
  LogicalProject(ENAME=[$1], GRADE=[$8])
    LogicalJoin(condition=[AND(>=($5, $9), <=($5, $10))], joinType=[inner])
      LogicalTableScan(table=[[scott, EMP]])
      LogicalTableScan(table=[[scott, SALGRADE]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
EnumerableCombine
  EnumerableProject(ENAME=[$4], DNAME=[$1])
    EnumerableHashJoin(condition=[=($0, $10)], joinType=[inner])
      EnumerableTableScan(table=[[scott, DEPT]])
      EnumerableTableScan(table=[[scott, EMP]])
  EnumerableProject(ENAME=[$1], GRADE=[$8])
    EnumerableNestedLoopJoin(condition=[AND(>=($5, $9), <=($5, $10))], joinType=[inner])
      EnumerableTableScan(table=[[scott, EMP]])
      EnumerableTableScan(table=[[scott, SALGRADE]])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testNoSharedExpressionsDifferentTables">
    <Resource name="planBefore">
      <![CDATA[
Combine
  LogicalProject(EMPNO=[$0], ENAME=[$1], SAL=[$5])
    LogicalTableScan(table=[[scott, EMP]])
  LogicalTableScan(table=[[scott, SALGRADE]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
EnumerableCombine
  EnumerableProject(EMPNO=[$0], ENAME=[$1], SAL=[$5])
    EnumerableTableScan(table=[[scott, EMP]])
  EnumerableTableScan(table=[[scott, SALGRADE]])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSharedAggregationBase">
    <Resource name="planBefore">
      <![CDATA[
Combine
  LogicalAggregate(group=[{7}], TOTAL_SAL=[SUM($5)])
    LogicalTableScan(table=[[scott, EMP]])
  LogicalFilter(condition=[>($1, 10000)])
    LogicalAggregate(group=[{7}], TOTAL_SAL=[SUM($5)])
      LogicalTableScan(table=[[scott, EMP]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
EnumerableCombine
  EnumerableTableSpool(readType=[LAZY], writeType=[LAZY], table=[[TEMP, spool_0]])
    EnumerableAggregate(group=[{7}], TOTAL_SAL=[SUM($5)])
      EnumerableTableScan(table=[[scott, EMP]])
  EnumerableFilter(condition=[>($1, 10000)])
    EnumerableInterpreter
      BindableTableScan(table=[[TEMP, spool_0]])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSharedComplexJoin">
    <Resource name="planBefore">
      <![CDATA[
Combine
  LogicalAggregate(group=[{9, 11}], EMP_COUNT=[COUNT()])
    LogicalJoin(condition=[AND(>=($5, $12), <=($5, $13))], joinType=[inner])
      LogicalJoin(condition=[=($7, $8)], joinType=[inner])
        LogicalTableScan(table=[[scott, EMP]])
        LogicalTableScan(table=[[scott, DEPT]])
      LogicalTableScan(table=[[scott, SALGRADE]])
  LogicalAggregate(group=[{9, 11}], AVG_SAL=[AVG($5)])
    LogicalJoin(condition=[AND(>=($5, $12), <=($5, $13))], joinType=[inner])
      LogicalJoin(condition=[=($7, $8)], joinType=[inner])
        LogicalTableScan(table=[[scott, EMP]])
        LogicalTableScan(table=[[scott, DEPT]])
      LogicalTableScan(table=[[scott, SALGRADE]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
EnumerableCombine
  EnumerableAggregate(group=[{9, 11}], EMP_COUNT=[COUNT()])
    EnumerableTableSpool(readType=[LAZY], writeType=[LAZY], table=[[TEMP, spool_0]])
      EnumerableNestedLoopJoin(condition=[AND(>=($5, $12), <=($5, $13))], joinType=[inner])
        EnumerableProject(EMPNO=[$3], ENAME=[$4], JOB=[$5], MGR=[$6], HIREDATE=[$7], SAL=[$8], COMM=[$9], DEPTNO=[$10], DEPTNO0=[$0], DNAME=[$1], LOC=[$2])
          EnumerableHashJoin(condition=[=($0, $10)], joinType=[inner])
            EnumerableTableScan(table=[[scott, DEPT]])
            EnumerableTableScan(table=[[scott, EMP]])
        EnumerableTableScan(table=[[scott, SALGRADE]])
  EnumerableProject(DNAME=[$0], GRADE=[$1], AVG_SAL=[CAST(/(CAST(CASE(=($3, 0), null:DECIMAL(19, 2), $2)):DECIMAL(7, 2), $3)):DECIMAL(7, 2)])
    EnumerableAggregate(group=[{9, 11}], agg#0=[$SUM0($5)], agg#1=[COUNT($5)])
      EnumerableInterpreter
        BindableTableScan(table=[[TEMP, spool_0]])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSharedFilter">
    <Resource name="planBefore">
      <![CDATA[
Combine
  LogicalProject(EMPNO=[$0], SAL=[$5])
    LogicalFilter(condition=[AND(>($5, 2000), =($7, 10))])
      LogicalTableScan(table=[[scott, EMP]])
  LogicalProject(ENAME=[$1], JOB=[$2])
    LogicalFilter(condition=[AND(>($5, 2000), =($7, 10))])
      LogicalTableScan(table=[[scott, EMP]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
EnumerableCombine
  EnumerableProject(EMPNO=[$0], SAL=[$5])
    EnumerableTableSpool(readType=[LAZY], writeType=[LAZY], table=[[TEMP, spool_0]])
      EnumerableFilter(condition=[AND(>($5, 2000), =($7, 10))])
        EnumerableTableScan(table=[[scott, EMP]])
  EnumerableProject(ENAME=[$1], JOB=[$2])
    EnumerableInterpreter
      BindableTableScan(table=[[TEMP, spool_0]])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSharedFilterJoinAggregate">
    <Resource name="planBefore">
      <![CDATA[
Combine
  LogicalAggregate(group=[{9}], HIGH_EARNER_CNT=[COUNT()])
    LogicalJoin(condition=[=($7, $8)], joinType=[inner])
      LogicalFilter(condition=[>($5, 2000)])
        LogicalTableScan(table=[[scott, EMP]])
      LogicalTableScan(table=[[scott, DEPT]])
  LogicalAggregate(group=[{9}], AVG_HIGH_SAL=[AVG($5)])
    LogicalJoin(condition=[=($7, $8)], joinType=[inner])
      LogicalFilter(condition=[>($5, 2000)])
        LogicalTableScan(table=[[scott, EMP]])
      LogicalTableScan(table=[[scott, DEPT]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
EnumerableCombine
  EnumerableAggregate(group=[{9}], HIGH_EARNER_CNT=[COUNT()])
    EnumerableTableSpool(readType=[LAZY], writeType=[LAZY], table=[[TEMP, spool_0]])
      EnumerableProject(EMPNO=[$3], ENAME=[$4], JOB=[$5], MGR=[$6], HIREDATE=[$7], SAL=[$8], COMM=[$9], DEPTNO=[$10], DEPTNO0=[$0], DNAME=[$1], LOC=[$2])
        EnumerableHashJoin(condition=[=($0, $10)], joinType=[inner])
          EnumerableTableScan(table=[[scott, DEPT]])
          EnumerableFilter(condition=[>($5, 2000)])
            EnumerableTableScan(table=[[scott, EMP]])
  EnumerableProject(DNAME=[$0], AVG_HIGH_SAL=[CAST(/(CAST(CASE(=($2, 0), null:DECIMAL(19, 2), $1)):DECIMAL(7, 2), $2)):DECIMAL(7, 2)])
    EnumerableAggregate(group=[{9}], agg#0=[$SUM0($5)], agg#1=[COUNT($5)])
      EnumerableInterpreter
        BindableTableScan(table=[[TEMP, spool_0]])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSharedFilterWithDifferentProjections">
    <Resource name="planBefore">
      <![CDATA[
Combine
  LogicalAggregate(group=[{}], CNT=[COUNT()])
    LogicalFilter(condition=[SEARCH($5, Sarg[[1000..3000]])])
      LogicalTableScan(table=[[scott, EMP]])
  LogicalAggregate(group=[{}], AVG_SAL=[AVG($5)])
    LogicalFilter(condition=[SEARCH($5, Sarg[[1000..3000]])])
      LogicalTableScan(table=[[scott, EMP]])
  LogicalProject(ENAME=[$1], SAL=[$5])
    LogicalFilter(condition=[SEARCH($5, Sarg[[1000..3000]])])
      LogicalTableScan(table=[[scott, EMP]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
EnumerableCombine
  EnumerableAggregate(group=[{}], CNT=[COUNT()])
    EnumerableTableSpool(readType=[LAZY], writeType=[LAZY], table=[[TEMP, spool_0]])
      EnumerableFilter(condition=[SEARCH($5, Sarg[[1000..3000]])])
        EnumerableTableScan(table=[[scott, EMP]])
  EnumerableProject(AVG_SAL=[CAST(/(CAST(CASE(=($1, 0), null:DECIMAL(19, 2), $0)):DECIMAL(7, 2), $1)):DECIMAL(7, 2)])
    EnumerableAggregate(group=[{}], agg#0=[$SUM0($5)], agg#1=[COUNT($5)])
      EnumerableInterpreter
        BindableTableScan(table=[[TEMP, spool_0]])
  EnumerableProject(ENAME=[$1], SAL=[$5])
    EnumerableInterpreter
      BindableTableScan(table=[[TEMP, spool_0]])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSharedJoin">
    <Resource name="planBefore">
      <![CDATA[
Combine
  LogicalProject(EMPNO=[$0], DNAME=[$9])
    LogicalJoin(condition=[=($7, $8)], joinType=[inner])
      LogicalTableScan(table=[[scott, EMP]])
      LogicalTableScan(table=[[scott, DEPT]])
  LogicalProject(ENAME=[$1], LOC=[$10])
    LogicalJoin(condition=[=($7, $8)], joinType=[inner])
      LogicalTableScan(table=[[scott, EMP]])
      LogicalTableScan(table=[[scott, DEPT]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
EnumerableCombine
  EnumerableProject(EMPNO=[$0], DNAME=[$9])
    EnumerableTableSpool(readType=[LAZY], writeType=[LAZY], table=[[TEMP, spool_0]])
      EnumerableProject(EMPNO=[$3], ENAME=[$4], JOB=[$5], MGR=[$6], HIREDATE=[$7], SAL=[$8], COMM=[$9], DEPTNO=[$10], DEPTNO0=[$0], DNAME=[$1], LOC=[$2])
        EnumerableHashJoin(condition=[=($0, $10)], joinType=[inner])
          EnumerableTableScan(table=[[scott, DEPT]])
          EnumerableTableScan(table=[[scott, EMP]])
  EnumerableProject(ENAME=[$1], LOC=[$10])
    EnumerableInterpreter
      BindableTableScan(table=[[TEMP, spool_0]])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSharedJoinThenAggregation">
    <Resource name="planBefore">
      <![CDATA[
Combine
  LogicalAggregate(group=[{9}], TOTAL_SAL=[SUM($5)])
    LogicalJoin(condition=[=($7, $8)], joinType=[inner])
      LogicalTableScan(table=[[scott, EMP]])
      LogicalTableScan(table=[[scott, DEPT]])
  LogicalAggregate(group=[{10}], EMP_CNT=[COUNT()])
    LogicalJoin(condition=[=($7, $8)], joinType=[inner])
      LogicalTableScan(table=[[scott, EMP]])
      LogicalTableScan(table=[[scott, DEPT]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
EnumerableCombine
  EnumerableAggregate(group=[{9}], TOTAL_SAL=[SUM($5)])
    EnumerableTableSpool(readType=[LAZY], writeType=[LAZY], table=[[TEMP, spool_0]])
      EnumerableProject(EMPNO=[$3], ENAME=[$4], JOB=[$5], MGR=[$6], HIREDATE=[$7], SAL=[$8], COMM=[$9], DEPTNO=[$10], DEPTNO0=[$0], DNAME=[$1], LOC=[$2])
        EnumerableHashJoin(condition=[=($0, $10)], joinType=[inner])
          EnumerableTableScan(table=[[scott, DEPT]])
          EnumerableTableScan(table=[[scott, EMP]])
  EnumerableAggregate(group=[{10}], EMP_CNT=[COUNT()])
    EnumerableInterpreter
      BindableTableScan(table=[[TEMP, spool_0]])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSharedMultipleFilters">
    <Resource name="planBefore">
      <![CDATA[
Combine
  LogicalAggregate(group=[{}], CNT=[COUNT()])
    LogicalFilter(condition=[=($7, 20)])
      LogicalFilter(condition=[>($5, 1500)])
        LogicalTableScan(table=[[scott, EMP]])
  LogicalProject(EMPNO=[$0], ENAME=[$1])
    LogicalFilter(condition=[=($7, 20)])
      LogicalFilter(condition=[>($5, 1500)])
        LogicalTableScan(table=[[scott, EMP]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
EnumerableCombine
  EnumerableAggregate(group=[{}], CNT=[COUNT()])
    EnumerableTableSpool(readType=[LAZY], writeType=[LAZY], table=[[TEMP, spool_0]])
      EnumerableFilter(condition=[AND(>($5, 1500), =($7, 20))])
        EnumerableTableScan(table=[[scott, EMP]])
  EnumerableProject(EMPNO=[$0], ENAME=[$1])
    EnumerableInterpreter
      BindableTableScan(table=[[TEMP, spool_0]])
]]>
    </Resource>
  </TestCase>
</Root>
